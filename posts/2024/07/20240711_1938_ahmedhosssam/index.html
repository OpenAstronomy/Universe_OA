<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The project is almost finished | Universe OpenAstronomy</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../../rss.xml">
<link rel="canonical" href="http://openastronomy.org/Universe_OA/posts/2024/07/20240711_1938_ahmedhosssam/">
<!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Ahmed Hossam">
<link rel="prev" href="../20240711_1548_kartikmandar/" title="Refactoring the codebase" type="text/html">
<link rel="next" href="../20240713_2230_deadspheroid/" title="Exploring OpenCL memory management" type="text/html">
<meta property="og:site_name" content="Universe OpenAstronomy">
<meta property="og:title" content="The project is almost finished">
<meta property="og:url" content="http://openastronomy.org/Universe_OA/posts/2024/07/20240711_1938_ahmedhosssam/">
<meta property="og:description" content="So, after I finished the main refactoring and the documentation strings, I started the testing phase.
I started with the smallest functions that don't call any non-tested function, and then went to th">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-07-11T19:38:21+01:00">
<meta property="article:tag" content="SunPy">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../../../">

            <span id="blog-title">Universe OpenAstronomy</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
            <style>
@media screen and (max-width: 600px) {
.table-done {
    visibility: hidden;
    clear: both;
    padding: 0px 300px;
    width: 50%;
    display: block;
  }
}
            </style>
<div class="sidebar" style="width:100%; max-width:100%; float:initial; margin:0px;"><ul>
<li>
                   <img src="https://openastronomy.org/img/members/radis_ico.png" height="16" width="16"><a href="https://medium.com/@darshvn" data-toggle="tooltip" data-placement="top" title="2025-06-07 04:22:57+01:00">
                    Darshan Patil
                   </a>
                   <span class="table-done" style="float: right; padding-right:600px;"><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-05-01 - 2025-06-02">❌</span><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-06-02 - 2025-06-16">✅</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-16 - 2025-06-30">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-30 - 2025-07-14">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-14 - 2025-07-28">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-28 - 2025-08-11">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-08-11 - 2025-08-25">🔲</span></span>
                </li>
<li>
                   <img src="https://github.com/juliaastro.png?size=40" height="16" width="16"><a href="https://kashish2210.blogspot.com" data-toggle="tooltip" data-placement="top" title="2025-06-13 07:32:00+01:00">
                    kashish shrivastav
                   </a>
                   <span class="table-done" style="float: right; padding-right:600px;"><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-05-01 - 2025-06-02">✅</span><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-06-02 - 2025-06-16">✅</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-16 - 2025-06-30">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-30 - 2025-07-14">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-14 - 2025-07-28">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-28 - 2025-08-11">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-08-11 - 2025-08-25">🔲</span></span>
                </li>
<li>
                   <img src="https://github.com/StingraySoftware.png?size=40" height="16" width="16"><a href="https://sejifukishima.blogspot.com" data-toggle="tooltip" data-placement="top" title="2025-06-04 18:03:00+01:00">
                    Mohammad Adnan
                   </a>
                   <span class="table-done" style="float: right; padding-right:600px;"><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-05-01 - 2025-06-02">❌</span><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-06-02 - 2025-06-16">✅</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-16 - 2025-06-30">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-30 - 2025-07-14">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-14 - 2025-07-28">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-28 - 2025-08-11">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-08-11 - 2025-08-25">🔲</span></span>
                </li>
<li>
                   <img src="https://openastronomy.org/img/members/radis_ico.png" height="16" width="16"><a href="https://medium.com/@mohyware" data-toggle="tooltip" data-placement="top" title="2025-06-05 02:25:44+01:00">
                    mohyware
                   </a>
                   <span class="table-done" style="float: right; padding-right:600px;"><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-05-01 - 2025-06-02">❌</span><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-06-02 - 2025-06-16">✅</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-16 - 2025-06-30">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-30 - 2025-07-14">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-14 - 2025-07-28">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-28 - 2025-08-11">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-08-11 - 2025-08-25">🔲</span></span>
                </li>
<li>
                   <img src="https://openastronomy.org/img/members/radis_ico.png" height="16" width="16"><a href="https://medium.com/@prathamhole" data-toggle="tooltip" data-placement="top" title="2025-06-07 09:49:18+01:00">
                    Pratham
                   </a>
                   <span class="table-done" style="float: right; padding-right:600px;"><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-05-01 - 2025-06-02">❌</span><span style="display:table-cell; width:7%;" data-toggle="tooltip" title="2025-06-02 - 2025-06-16">✅</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-16 - 2025-06-30">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-06-30 - 2025-07-14">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-14 - 2025-07-28">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-07-28 - 2025-08-11">🔲</span><span style="display:table-cell; width:7%;opacity: 0.5;" data-toggle="tooltip" title="2025-08-11 - 2025-08-25">🔲</span></span>
                </li>
</ul></div>
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">The project is almost finished</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../../authors/ahmed-hossam/">Ahmed Hossam</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2024-07-11T19:38:21+01:00" itemprop="datePublished" title="2024-07-11 19:38">2024-07-11 19:38</time></a>
            </p>
            

                    <p class="linkline"><a href="https://dev.to/ahmedhosssam/the-project-is-almost-finished-1hfb">Original site</a></p>
        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>So, after I finished the main refactoring and the documentation strings, I started the testing phase.<br>
I started with the smallest functions that don't call any non-tested function, and then went to the bigger functions.</p>

<!-- TEASER_END -->
<p>After finishing the main unit tests, I had a problem, the columns in the input data from the hek have different units, for example, for <code>event_coord1</code> we have some rows with degrees and others with arcsecond, and the result would be a column with one unit, the degrees are converted into arcseconds or vice versa. So me and my mentor decided to:</p>

<ol>
<li>Merge <code>event_coord1</code> and <code>event_coord2</code> and <code>event_coord3</code> into one <code>SkyCoord</code> object for every row.
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="k">if</span> <span class="n">is_coord_prop</span><span class="p">:</span>
<span class="n">event_coord_col</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coord1</span><span class="sh">'</span><span class="p">])):</span>
<span class="n">unit</span> <span class="o">=</span> <span class="nf">get_unit</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coordunit</span><span class="sh">'</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
<span class="n">coord1</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coord1</span><span class="sh">'</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
<span class="n">coord2</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coord2</span><span class="sh">'</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
<span class="n">coord3</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coord3</span><span class="sh">'</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
<span class="n">frame</span> <span class="o">=</span> <span class="sh">'</span><span class="s">helioprojective</span><span class="sh">'</span> <span class="k">if</span> <span class="n">unit</span><span class="o">==</span><span class="n">u</span><span class="p">.</span><span class="n">arcsec</span> <span class="k">else</span> <span class="sh">'</span><span class="s">icrs</span><span class="sh">'</span>
<span class="k">if</span> <span class="n">coord3</span><span class="p">:</span>
<span class="n">event_coord</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord1</span><span class="o">*</span><span class="n">unit</span><span class="p">,</span> <span class="n">coord2</span><span class="o">*</span><span class="n">unit</span><span class="p">,</span> <span class="n">coord3</span><span class="o">*</span><span class="n">unit</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<span class="n">event_coord</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord1</span><span class="o">*</span><span class="n">unit</span><span class="p">,</span> <span class="n">coord2</span><span class="o">*</span><span class="n">unit</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
<span class="n">event_coord_col</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">event_coord</span><span class="p">)</span>
<span class="n">event_coord_col</span> <span class="o">=</span> <span class="nc">Column</span><span class="p">(</span><span class="n">event_coord_col</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">event_coord</span><span class="sh">'</span><span class="p">)</span>
<span class="k">del</span> <span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coord1</span><span class="sh">'</span><span class="p">]</span>
<span class="k">del</span> <span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coord2</span><span class="sh">'</span><span class="p">]</span>
<span class="k">del</span> <span class="n">table</span><span class="p">[</span><span class="sh">'</span><span class="s">event_coord3</span><span class="sh">'</span><span class="p">]</span>
<span class="n">table</span><span class="p">.</span><span class="nf">add_column</span><span class="p">(</span><span class="n">event_coord_col</span><span class="p">)</span>
</code></pre>

</div>


<ol>
<li>The other columns that has multiple units would be converted into astropy column first and then added to the table
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="k">if</span> <span class="ow">not</span> <span class="n">attribute</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">is_chaincode</span><span class="sh">"</span><span class="p">):</span>
<span class="n">new_column</span> <span class="o">=</span> <span class="nc">Column</span><span class="p">(</span><span class="n">new_column</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">u</span><span class="p">.</span><span class="n">Quantity</span><span class="p">)</span>
</code></pre>

</div>


<p>After this, I started a mission of checking the resulting columns and comparing them to the input and also to the expected results. And here I saw some surprises:<br>
There are columns that don't even exist in the <a href="https://www.lmsal.com/hek/VOEvent_Spec.html" rel="noopener noreferrer">HEK Feature/Event Types definitions<br></a>:</p>

<ul>
<li>hgc_coord</li>
<li>hpc_coord</li>
<li>hgs_coord</li>
<li>hrc_coord</li>
<li>hgc_boundcc</li>
<li>hpc_boundcc</li>
<li>hgs_boundcc</li>
<li>hrc_boundcc</li>
</ul>
<p>So I had to add them into <code>coord_properties.json</code> file with double-checking the frames.</p>

<p>hgc_coord, hpc_coord, hgs_coord, hrc_coord are points, so they had to be converted into <code>PointSkyRegion</code>.<br>
And they were supported in <code>parse_chaincode</code>:<br></p>

<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="k">def</span> <span class="nf">parse_chaincode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="k">if</span> <span class="n">attribute</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">is_point</span><span class="sh">"</span><span class="p">):</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">POINT(</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">split</span><span class="p">()</span>
<span class="n">coord_list</span> <span class="o">=</span> <span class="p">[</span><span class="nf">float</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span> <span class="k">for</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">]</span>
<span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">coord1_unit</span>
<span class="n">coord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">coord2_unit</span>
<span class="k">if</span> <span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">heliocentric</span><span class="sh">"</span><span class="p">:</span>
<span class="n">center_sky</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="n">coord_list</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">.</span><span class="n">AU</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">representation_type</span><span class="o">=</span><span class="sh">"</span><span class="s">cylindrical</span><span class="sh">"</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">])</span>
<span class="k">return</span> <span class="nc">PolygonSkyRegion</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">center_sky</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<span class="n">center_sky</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">])</span>
<span class="k">return</span> <span class="nc">PointSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center_sky</span><span class="p">)</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
</code></pre>

</div>



<p>So far so good.</p>

<p>Also, some tests in <code>test_hek</code> were simplified, instead of checking if the object is instance of PolygonSkyRegion or PointSkyRegion, we can just check if it's instance of SkyRegion which is the base class for all regions defined in celestial coordinates.</p>

<p>Also, another update to <code>parse_chaincode</code>, the observation time were added to the parameter to be added to all the region objects. We used the column <code>event_starttime</code> to specify the obstime of the event. And we also I added the observer as <code>earth</code>, I still don't know if this would be correct for the different conditions and different queries of the hek, but we will see, and also I wrote a comment to highlight the assumption.</p>

<p>Here is the complete implementation of <code>parse_chaincode</code>:<br></p>

<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="k">def</span> <span class="nf">parse_chaincode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="sh">"""</span><span class="s">
Parses a string representation of coordinates and convert them into a PolygonSkyRegion object
using units based on the specified coordinate frame.

Parameters
----------
value : str
A polygon defined using vertices in sky coordinates.
attribute : dict
An object from </span><span class="sh">"</span><span class="s">coord_properties.json</span><span class="sh">"</span><span class="s">
unit : str
The unit of the coordinates
time : `~astropy.time.core.Time`
An event_starttime row parsed into astropy time.

Returns
-------
`PolygonSkyRegion`
A polygon defined using vertices in sky coordinates.

Raises
------
IndexError
Because ``value`` does not contain the expected </span><span class="sh">'</span><span class="s">((</span><span class="sh">'</span><span class="s"> and </span><span class="sh">'</span><span class="s">))</span><span class="sh">'</span><span class="s"> substrings.
UnitConversionError
Because the units set by ``coord1_unit`` or ``coord2_unit`` are incompatible with the values being assigned.
</span><span class="sh">"""</span>
<span class="n">observer</span> <span class="o">=</span> <span class="sh">'</span><span class="s">earth</span><span class="sh">'</span> <span class="c1"># There is an assumption that earth is the observer.
</span>    <span class="n">coord1_unit</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">deg</span>
<span class="n">coord2_unit</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">deg</span>
<span class="k">if</span> <span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">helioprojective</span><span class="sh">"</span><span class="p">:</span>
<span class="n">coord1_unit</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">arcsec</span>
<span class="n">coord2_unit</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">arcsec</span>
<span class="k">elif</span> <span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">heliocentric</span><span class="sh">"</span><span class="p">:</span>
<span class="n">coord1_unit</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">R_sun</span> <span class="c1"># Nominal solar radius
</span>    <span class="k">elif</span> <span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">icrs</span><span class="sh">"</span><span class="p">:</span>
<span class="n">coord1_unit</span> <span class="o">=</span> <span class="nf">get_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<span class="n">coord2_unit</span> <span class="o">=</span> <span class="nf">get_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>

<span class="k">if</span> <span class="n">attribute</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">is_point</span><span class="sh">"</span><span class="p">):</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">POINT(</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">split</span><span class="p">()</span>
<span class="n">coord_list</span> <span class="o">=</span> <span class="p">[</span><span class="nf">float</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span> <span class="k">for</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">]</span>
<span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">coord1_unit</span>
<span class="n">coord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">coord2_unit</span>
<span class="k">if</span> <span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">heliocentric</span><span class="sh">"</span><span class="p">:</span>
<span class="n">center_sky</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="n">coord_list</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">.</span><span class="n">AU</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">representation_type</span><span class="o">=</span><span class="sh">"</span><span class="s">cylindrical</span><span class="sh">"</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">])</span>
<span class="k">return</span> <span class="nc">PolygonSkyRegion</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">center_sky</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<span class="n">center_sky</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">])</span>
<span class="k">return</span> <span class="nc">PointSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center_sky</span><span class="p">)</span>
<span class="n">coordinates_str</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">((</span><span class="sh">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">))</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">coord1_list</span> <span class="o">=</span> <span class="p">[</span><span class="nf">float</span><span class="p">(</span><span class="n">coord</span><span class="p">.</span><span class="nf">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coordinates_str</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)]</span> <span class="o">*</span> <span class="n">coord1_unit</span>
<span class="n">coord2_list</span> <span class="o">=</span> <span class="p">[</span><span class="nf">float</span><span class="p">(</span><span class="n">coord</span><span class="p">.</span><span class="nf">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coordinates_str</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)]</span> <span class="o">*</span> <span class="n">coord2_unit</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">heliocentric</span><span class="sh">"</span><span class="p">:</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord1_list</span><span class="p">,</span> <span class="n">coord2_list</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="n">coord1_list</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">.</span><span class="n">AU</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">representation_type</span><span class="o">=</span><span class="sh">"</span><span class="s">cylindrical</span><span class="sh">"</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="sh">"</span><span class="s">heliocentric</span><span class="sh">"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span><span class="n">coord1_list</span><span class="p">,</span> <span class="n">coord2_list</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">attribute</span><span class="p">[</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">])</span>

<span class="k">return</span> <span class="nc">PolygonSkyRegion</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">vertices</span><span class="p">)</span>
</code></pre>

</div>



<p>One major outcome of this project was to make using hek and acquiring data from it easy, and this happened when I saw some errors from the CI and when I checked it I saw that one example of <code>overplot_hek_polygon.py</code> should be modified due to the interface changing and the returned data types.<br>
This was the initial using of hek in this example:<br></p>

<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="n">ch</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">response_index</span><span class="p">]</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="sh">"</span><span class="s">hpc_boundcc</span><span class="sh">"</span><span class="p">][</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)</span>
<span class="n">p3</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p2</span><span class="p">]</span>
<span class="n">ch_date</span> <span class="o">=</span> <span class="nf">parse_time</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="sh">'</span><span class="s">event_starttime</span><span class="sh">'</span><span class="p">])</span>
<span class="n">ch_boundary</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">response_index</span><span class="p">][</span><span class="sh">"</span><span class="s">hpc_boundcc</span><span class="sh">"</span><span class="p">]</span>

<span class="c1">##############################################################################
# The coronal hole was detected at different time than the AIA image was
# taken so we need to rotate it to the map observation time.
</span>
<span class="n">ch_boundary</span> <span class="o">=</span> <span class="nc">SkyCoord</span><span class="p">(</span>
<span class="p">[(</span><span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">u</span><span class="p">.</span><span class="n">arcsec</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p3</span><span class="p">],</span>
<span class="n">obstime</span><span class="o">=</span><span class="n">ch_date</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="sh">"</span><span class="s">earth</span><span class="sh">"</span><span class="p">,</span>
<span class="n">frame</span><span class="o">=</span><span class="n">frames</span><span class="p">.</span><span class="n">Helioprojective</span><span class="p">)</span>
<span class="n">rotated_ch_boundary</span> <span class="o">=</span> <span class="nf">solar_rotate_coordinate</span><span class="p">(</span><span class="n">ch_boundary</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">aia_map</span><span class="p">.</span><span class="n">date</span><span class="p">)</span>
</code></pre>

</div>



<p>And now it became this:<br></p>

<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="n">ch</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">response_index</span><span class="p">]</span>
<span class="n">ch_boundary</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">response_index</span><span class="p">][</span><span class="sh">"</span><span class="s">hpc_boundcc</span><span class="sh">"</span><span class="p">].</span><span class="n">vertices</span>

<span class="c1"># The coronal hole was detected at different time than the AIA image was
# taken so we need to rotate it to the map observation time.
</span>
<span class="n">rotated_ch_boundary</span> <span class="o">=</span> <span class="nf">solar_rotate_coordinate</span><span class="p">(</span><span class="n">ch_boundary</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">aia_map</span><span class="p">.</span><span class="n">date</span><span class="p">)</span>
</code></pre>

</div>



<p>Yeah, and that's it.<br>
The remaining parts are writing the user documentation, and double-checking the returned data from different events and different queries.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../categories/sunpy/" rel="tag">SunPy</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../20240711_1548_kartikmandar/" rel="prev" title="Refactoring the codebase">Previous post</a>
            </li>
            <li class="next">
                <a href="../20240713_2230_deadspheroid/" rel="next" title="Exploring OpenCL memory management">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2025         <a href="mailto:openastronomy@openastronomy.com">OpenAstronomy</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
<img alt="Creative Commons License BY-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a>
            
            
        </footer>
</div>
</div>


        <script src="../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
